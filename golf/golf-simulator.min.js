class BallFlight{constructor(){this.dragScale=.919313,this.magnusScale=.458821,this.liftCoeffBase=96.346629,this.liftCoeffSpinRate=.786747,this.gravity=-9.81,this.bounceDamping=.7,this.airDensity=1.225,this.ballMass=.04593,this.ballRadius=.021335}setParameters(t,e,i,s){this.dragScale=t,this.magnusScale=e,this.liftCoeffBase=i,this.liftCoeffSpinRate=s}simulate(t){var e=[],i=.44704*t.ballSpeed,s=t.VLA*Math.PI/180,a=t.HLA*Math.PI/180,h={x:0,y:this.ballRadius,z:0},o={x:i*Math.cos(s)*Math.sin(a),y:i*Math.sin(s),z:-i*Math.cos(s)*Math.cos(a)},n={rate:t.spinRate,axis:t.spinAxis};let l=0,r=!1,c=0;for(;l<15&&(0<h.y||!r);){if(e.push({time:l,position:{...h},velocity:{...o},spin:{...n}}),this.updatePhysics(h,o,n,.016),h.y<=this.ballRadius&&!r&&(h.y=this.ballRadius,r=!0,c=Math.sqrt(h.x*h.x+h.z*h.z),o.y=-o.y*this.bounceDamping,o.x*=.4,o.z*=.4),r&&Math.abs(o.y)<1)if(o.x*=.7,o.z*=.7,Math.sqrt(o.x*o.x+o.z*o.z)<1.5){o.x=0,o.z=0;break}l+=.016}i=Math.sqrt(h.x*h.x+h.z*h.z);return{trajectory:e,carryDistanceYards:1.09361*c,totalDistanceYards:1.09361*i,flightTime:l,maxHeight:1.09361*Math.max(...e.map(t=>t.position.y)),landingAngle:this.calculateLandingAngle(e)}}updatePhysics(t,e,i,s){var a=Math.sqrt(e.x*e.x+e.y*e.y+e.z*e.z);let h;h=a<30?.47:a<50?.47-(a-30)/20*.27:.2;var o=Math.PI*this.ballRadius*this.ballRadius,n=.5*this.airDensity*h*o*a*a*this.dragScale;0<a&&(n=n/this.ballMass,e.x-=e.x/a*n*s,e.y-=e.y/a*n*s,e.z-=e.z/a*n*s),0<i.rate&&(i.rate,Math.PI,n=i.axis*Math.PI/180,i=Math.min(.3,this.liftCoeffBase+i.rate*this.liftCoeffSpinRate),o=(i=.5*this.airDensity*i*o*a*a*this.magnusScale)/this.ballMass*Math.cos(n),a=i/this.ballMass*Math.sin(n),e.y+=o*s,e.x+=a*s),e.y+=this.gravity*s,t.x+=e.x*s,t.y+=e.y*s,t.z+=e.z*s}calculateLandingAngle(e){if(e.length<10)return null;let i=-1;for(let t=0;t<e.length-1;t++){var s=e[t],a=e[t+1];if(s.position.y>this.ballRadius&&a.position.y<=this.ballRadius){i=t;break}}var t,h;return i<1||(t=(h=e[i]).velocity.y,0===(h=Math.abs(h.velocity.z)))?null:180*Math.atan2(-t,h)/Math.PI}updatePhysicsRealtime(t,e,i,s){this.updatePhysics(t,e,i,s),t.y<=this.ballRadius&&(t.y=this.ballRadius,e.y=-e.y*this.bounceDamping,e.x*=.4,e.z*=.4),t.y<=this.ballRadius&&Math.abs(e.y)<1&&(e.x*=.7,e.z*=.7,Math.sqrt(e.x*e.x+e.z*e.z)<1.5)&&(e.x=0,e.z=0)}}"undefined"!=typeof module&&module.exports&&(module.exports=BallFlight);class GolfSimulator{constructor(){this.scene=null,this.camera=null,this.renderer=null,this.ground=null,this.golfBall=null,this.ballVelocity={x:0,y:0,z:0},this.ballSpin={rate:0,axis:0},this.ballFlight=new BallFlight,this.shotTracer=null,this.tracerPoints=[],this.maxTracerPoints=300,this.shotData=null,this.carryDistance=0,this.totalDistance=0,this.ballLanded=!1,this.distanceToPin=0,this.cameraFollowMode=!0,this.strokes=0,this.finalScore=null,this.ballRestPosition={x:0,y:0,z:0},this.shotStartPosition={x:0,y:0,z:0},this.aimLine={angle:0,dx:0,dz:0},this.originalCameraPosition={x:-10,y:12,z:20},this.originalCameraTarget={x:0,y:5,z:-50},this.pinPosition={x:0,z:-80},this.updateDistanceToPin(),this.updateAimLine(),this.clubs={driver:{ballSpeed:167,VLA:11,spinRate:2545},"3wood":{ballSpeed:155,VLA:12,spinRate:3200},"5iron":{ballSpeed:135,VLA:16,spinRate:5800},"6iron":{ballSpeed:127,VLA:17,spinRate:6204},"7iron":{ballSpeed:120,VLA:19,spinRate:6600},"8iron":{ballSpeed:110,VLA:22,spinRate:7200},"9iron":{ballSpeed:100,VLA:25,spinRate:8e3},pw:{ballSpeed:86,VLA:27,spinRate:9e3},sw:{ballSpeed:75,VLA:30,spinRate:10500},lw:{ballSpeed:65,VLA:35,spinRate:12e3},chip:{ballSpeed:55,VLA:20,spinRate:6e3}},this.init(),this.createLighting(),this.createGround(),this.createGolfBall(),this.createShotTracer(),this.setCameraForAiming(),this.animate()}init(){this.scene=new THREE.Scene,this.scene.fog=new THREE.Fog(8900331,500,2e3),this.camera=new THREE.PerspectiveCamera(75,window.innerWidth/window.innerHeight,.1,2e3),this.camera.position.set(-10,12,20),this.camera.lookAt(0,5,-50),this.renderer=new THREE.WebGLRenderer({antialias:!0}),this.renderer.setSize(window.innerWidth,window.innerHeight),this.renderer.setPixelRatio(window.devicePixelRatio),this.renderer.shadowMap.enabled=!0,this.renderer.shadowMap.type=THREE.PCFSoftShadowMap,this.renderer.setClearColor(8900331),document.getElementById("container").appendChild(this.renderer.domElement),window.addEventListener("resize",()=>this.onWindowResize()),window.addEventListener("keydown",t=>{"Space"===t.code&&this.hitSelectedClub()}),document.getElementById("hitBall").addEventListener("click",()=>{this.hitSelectedClub()})}createLighting(){var t=new THREE.AmbientLight(4210752,.4),t=(this.scene.add(t),new THREE.DirectionalLight(16777215,1));t.position.set(100,100,50),t.castShadow=!0,t.shadow.mapSize.width=2048,t.shadow.mapSize.height=2048,t.shadow.camera.near=.5,t.shadow.camera.far=500,t.shadow.camera.left=-100,t.shadow.camera.right=100,t.shadow.camera.top=100,t.shadow.camera.bottom=-100,this.scene.add(t)}createGround(){this.createGolfHole()}createGolfHole(){var t=new THREE.PlaneGeometry(400,200),e=new THREE.MeshLambertMaterial({color:3101235}),t=new THREE.Mesh(t,e),e=(t.rotation.x=-Math.PI/2,t.receiveShadow=!0,this.scene.add(t),new THREE.BoxGeometry(8,.2,6)),t=new THREE.MeshLambertMaterial({color:3329330}),e=new THREE.Mesh(e,t),t=(e.position.set(0,.1,80),e.receiveShadow=!0,this.scene.add(e),new THREE.PlaneGeometry(200,600)),e=new THREE.MeshLambertMaterial({color:2263842}),t=new THREE.Mesh(t,e),e=(t.rotation.x=-Math.PI/2,t.position.set(0,.01,-50),t.receiveShadow=!0,this.scene.add(t),new THREE.CircleGeometry(15,32)),t=new THREE.MeshLambertMaterial({color:9498256}),e=new THREE.Mesh(e,t);e.rotation.x=-Math.PI/2,e.position.set(0,.02,-80),e.receiveShadow=!0,this.scene.add(e),this.createFlag(),this.createTrees(),this.createBunker()}createFlag(){var t=new THREE.CylinderGeometry(.05,.05,4),e=new THREE.MeshLambertMaterial({color:16777215}),t=new THREE.Mesh(t,e),e=(t.position.set(0,2,-80),t.castShadow=!0,this.scene.add(t),new THREE.PlaneGeometry(2,1.5)),t=new THREE.MeshLambertMaterial({color:16711680,side:THREE.DoubleSide}),e=new THREE.Mesh(e,t);e.position.set(1,3.2,-80),this.scene.add(e)}createTrees(){for(let i=0;i<8;i++){var s=new THREE.CylinderGeometry(.5,.8,6),a=new THREE.MeshLambertMaterial({color:9127187}),s=new THREE.Mesh(s,a),a=new THREE.SphereGeometry(4,8,6),h=new THREE.MeshLambertMaterial({color:1003826}),a=new THREE.Mesh(a,h),h=i/8*Math.PI*2,o=60+40*Math.random();let t=Math.cos(h)*o,e=Math.sin(h)*o;Math.sqrt(t*t+(e+80)*(e+80))<25&&(h=Math.atan2(t,e+80),t=30*Math.sin(h),e=30*Math.cos(h)-80),s.position.set(t,3,e),a.position.set(t,8,e),s.castShadow=!0,a.castShadow=!0,this.scene.add(s),this.scene.add(a)}}createBunker(){var t=new THREE.CircleGeometry(8,16),e=new THREE.MeshLambertMaterial({color:16032864}),t=new THREE.Mesh(t,e);t.rotation.x=-Math.PI/2,t.position.set(12,-.2,-60),t.receiveShadow=!0,this.scene.add(t)}addGroundGrid(){}createGolfBall(){var t=new THREE.SphereGeometry(this.ballFlight.ballRadius,32,32),e=new THREE.MeshPhongMaterial({color:16777215,shininess:30,specular:1118481});this.golfBall=new THREE.Mesh(t,e),this.golfBall.position.set(0,this.ballFlight.ballRadius,0),this.golfBall.castShadow=!0,this.scene.add(this.golfBall)}createShotTracer(){this.tracerGroup=new THREE.Group,this.scene.add(this.tracerGroup),this.tracerSpheres=[];var e=new THREE.SphereGeometry(.15,6,4),i=new THREE.MeshBasicMaterial({color:16724736,transparent:!0,opacity:.9});for(let t=0;t<50;t++){var s=new THREE.Mesh(e,i);s.visible=!1,this.tracerSpheres.push(s),this.tracerGroup.add(s)}var t=new THREE.BufferGeometry,a=new Float32Array(3*this.maxTracerPoints),a=(t.setAttribute("position",new THREE.BufferAttribute(a,3)),new THREE.LineBasicMaterial({color:16724736,transparent:!0,opacity:1,depthTest:!1,depthWrite:!1}));this.shotTracer=new THREE.Line(t,a),this.scene.add(this.shotTracer),this.shotTracer.visible=!1}onWindowResize(){this.camera.aspect=window.innerWidth/window.innerHeight,this.camera.updateProjectionMatrix(),this.renderer.setSize(window.innerWidth,window.innerHeight)}animate(){requestAnimationFrame(()=>this.animate()),this.updatePhysics(),this.renderer.render(this.scene,this.camera)}updatePhysics(){this.ballFlight.updatePhysicsRealtime(this.golfBall.position,this.ballVelocity,this.ballSpin,.016);var t,e=this.shotData&&(.1<Math.abs(this.ballVelocity.x)||.1<Math.abs(this.ballVelocity.y)||.1<Math.abs(this.ballVelocity.z));e?(this.updateShotTracer(),this.updateCameraFollow()):this.shotData&&!e&&(this.ballRestPosition.x=this.golfBall.position.x,this.ballRestPosition.y=this.golfBall.position.y,this.ballRestPosition.z=this.golfBall.position.z,this.updateDistanceToPin(),this.distanceToPin<=30&&null===this.finalScore&&(this.finalScore=this.strokes+2,this.updateScoreDisplay()),this.updateAimLine(),setTimeout(()=>{this.setCameraForAiming()},2e3)),this.golfBall.position.y<=this.ballFlight.ballRadius&&!this.ballLanded&&(this.ballLanded=!0,e=this.golfBall.position.x-this.shotStartPosition.x,t=this.golfBall.position.z-this.shotStartPosition.z,e=Math.sqrt(e*e+t*t),this.carryDistance=1.09361*e,this.updateMetricsDisplay()),this.shotData&&(t=this.golfBall.position.x-this.shotStartPosition.x,e=this.golfBall.position.z-this.shotStartPosition.z,t=Math.sqrt(t*t+e*e),this.totalDistance=1.09361*t,Math.floor(Date.now()/100)%3==0)&&(this.updateMetricsDisplay(),this.updateDistanceToPin()),this.golfBall.rotation.x+=.016*this.ballVelocity.z*2,this.golfBall.rotation.z-=.016*this.ballVelocity.x*2}updateShotTracer(){this.tracerPoints.push(this.golfBall.position.clone()),this.tracerPoints.length>this.maxTracerPoints&&this.tracerPoints.shift();var e=Math.max(1,Math.floor(this.tracerPoints.length/this.tracerSpheres.length));for(let t=0;t<this.tracerSpheres.length;t++){var i=t*e;i<this.tracerPoints.length?(i=this.tracerPoints[i],this.tracerSpheres[t].position.copy(i),this.tracerSpheres[t].visible=!0):this.tracerSpheres[t].visible=!1}var s=this.shotTracer.geometry.attributes.position.array;for(let t=0;t<this.tracerPoints.length;t++){var a=this.tracerPoints[t];s[3*t]=a.x,s[3*t+1]=a.y,s[3*t+2]=a.z}for(let t=this.tracerPoints.length;t<this.maxTracerPoints;t++)s[3*t]=0,s[3*t+1]=0,s[3*t+2]=0;this.shotTracer.geometry.attributes.position.needsUpdate=!0,this.shotTracer.geometry.setDrawRange(0,this.tracerPoints.length),this.shotTracer.visible=!0,this.tracerGroup.visible=!0}launchBall(t){this.golfBall.position.set(this.ballRestPosition.x,Math.max(this.ballFlight.ballRadius,this.ballRestPosition.y),this.ballRestPosition.z),this.shotStartPosition.x=this.ballRestPosition.x,this.shotStartPosition.y=this.ballRestPosition.y,this.shotStartPosition.z=this.ballRestPosition.z;var e=.44704*t.ballSpeed,i=t.VLA*Math.PI/180,s=(this.aimLine.angle+t.HLA)*Math.PI/180;this.ballVelocity.x=e*Math.cos(i)*Math.sin(s),this.ballVelocity.y=e*Math.sin(i),this.ballVelocity.z=-e*Math.cos(i)*Math.cos(s),this.ballSpin.rate=t.spinRate,this.ballSpin.axis=t.spinAxis,this.shotData=t,this.carryDistance=0,this.totalDistance=0,this.ballLanded=!1,this.tracerPoints=[],this.shotTracer.visible=!1,this.tracerSpheres&&this.tracerSpheres.forEach(t=>t.visible=!1),this.tracerGroup&&(this.tracerGroup.visible=!1),this.updateMetricsDisplay()}updateMetricsDisplay(){this.shotData&&(document.getElementById("ballSpeed").textContent=this.shotData.ballSpeed+" mph",document.getElementById("launchAngle").textContent=this.shotData.VLA+"°",document.getElementById("launchDirection").textContent=this.shotData.HLA+"°",document.getElementById("spinRate").textContent=this.shotData.spinRate+" rpm",document.getElementById("spinAxis").textContent=this.shotData.spinAxis+"°",document.getElementById("carryDistance").textContent=Math.round(this.carryDistance)+" yds",document.getElementById("totalDistance").textContent=Math.round(this.totalDistance)+" yds")}hitSelectedClub(){var t=document.getElementById("clubSelect").value,t=this.clubs[t];t&&(this.tracerPoints=[],this.shotTracer.visible=!1,this.tracerSpheres&&this.tracerSpheres.forEach(t=>t.visible=!1),this.tracerGroup&&(this.tracerGroup.visible=!1),this.strokes++,this.updateScoreDisplay(),this.launchBall({ballSpeed:t.ballSpeed,VLA:t.VLA,HLA:0,spinRate:t.spinRate,spinAxis:0}))}testShot(){this.hitSelectedClub()}updateDistanceToPin(){var t=this.golfBall?this.golfBall.position.x:0,e=this.golfBall?this.golfBall.position.z:0,t=this.pinPosition.x-t,e=this.pinPosition.z-e;this.distanceToPin=1.09361*Math.sqrt(t*t+e*e),document.getElementById("distanceToPin").textContent=Math.round(this.distanceToPin)+" yds"}updateScoreDisplay(){document.getElementById("strokes").textContent=this.strokes,null!==this.finalScore?document.getElementById("score").textContent=this.finalScore+" (Final)":document.getElementById("score").textContent="--"}updateCameraFollow(){var t,e,i,s,a,h;this.cameraFollowMode&&this.shotData&&(t=this.golfBall.position,e=this.ballVelocity,.5<(i=Math.sqrt(e.x*e.x+e.z*e.z))?(s=-e.x/i,i=-e.z/i,a=t.x+20*s+8*-i,h=t.y+12,i=t.z+20*i+8*s,this.camera.position.lerp(new THREE.Vector3(a,h,i),.03)):this.camera.position.lerp(new THREE.Vector3(t.x-15,t.y+15,t.z+20),.02),s=t.x+.5*e.x,a=t.y+2,h=t.z+.5*e.z,this.camera.lookAt(s,a,h))}resetCamera(){this.camera.position.set(this.originalCameraPosition.x,this.originalCameraPosition.y,this.originalCameraPosition.z),this.camera.lookAt(this.originalCameraTarget.x,this.originalCameraTarget.y,this.originalCameraTarget.z)}updateAimLine(){var t=this.ballRestPosition.x,e=this.ballRestPosition.z;this.aimLine.dx=this.pinPosition.x-t,this.aimLine.dz=this.pinPosition.z-e,this.aimLine.angle=180*Math.atan2(this.aimLine.dx,-this.aimLine.dz)/Math.PI}setCameraForAiming(){var t=this.ballRestPosition.x,e=this.ballRestPosition.z,i=Math.sqrt(this.aimLine.dx*this.aimLine.dx+this.aimLine.dz*this.aimLine.dz),s=-this.aimLine.dx/i,i=-this.aimLine.dz/i;this.camera.position.set(t+15*s+5*-i,8,e+15*i+5*s),this.camera.lookAt(this.pinPosition.x,2,this.pinPosition.z)}}let simulator=new GolfSimulator;